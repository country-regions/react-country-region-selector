/**
 * This script is called on bootstrap to generate a minified version of the source data from
 * country-region-data:
 * https://github.com/country-regions/country-region-data
 *
 * Example: `npm run minify-data -- --config-countries=GB,CA,US
 */
const argv = require('minimist');
const args = argv(process.argv.slice(2));
const fs = require('fs');
const path = require('path');

let countryRegions = require('country-region-data/data.json');

const minifyCountryData = (countries) => {
  return countries.map((countryData) => [
    countryData.countryName,
    countryData.countryShortCode,
    countryData.regions
      .map((regionData) => `${regionData.name}~${regionData.shortCode || ''}`)
      .join('|'),
  ]);
};

let countries = [];
if (args.hasOwnProperty('config-countries')) {
  countries = args['config-countries'].split(',');
}

// filter out those countries that the user wants
if (countries.length > 0) {
  countryRegions = countryRegions.filter(
    (countryData) => countries.indexOf(countryData.countryShortCode) !== -1
  );
}

const srcFolder = path.resolve(__dirname, '../src');

const data = JSON.stringify(minifyCountryData(countryRegions), undefined, '  ');
const tsData = `
/**
 * Auto-generated by 'npm run minify-data'.
 */
import { CountryRegionDataMinified } from './types';

const data: CountryRegionDataMinified[] = ${data};

export default data;
`;
fs.writeFileSync(`${srcFolder}/_data.ts`, tsData);
